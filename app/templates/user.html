{% extends "base.html" %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
{% endblock %}

{% block content %}
<div class="profile-wrapper">
  <div class="profile-card">
    <img src="{{ user.avatar(128) }}" alt="{{ user.full_name }}" class="avatar">

    <div class="profile-info">
      <div class="profile-name">{{ user.full_name }}</div>

      {% if user.about %}
      <div class="profile-about">{{ user.about }}</div>
      {% endif %}

      <div class="stats">
        <a href="#" data-toggle="modal" data-target="#followersModal">
          {{ user.followers.count() }}<span>Подписчики</span>
        </a>
        <a href="#" data-toggle="modal" data-target="#followingModal">
          {{ user.followed.count() }}<span>Подписки</span>
        </a>
      </div>

      <div class="action-btn">
        {% if user != current_user %}
        <form method="post" action="{{ url_for('follow' if not current_user.is_following(user) else 'unfollow', username=user.username) }}">
          {{ form.hidden_tag() }}
          <button type="submit" class="btn-primary">
            {{ 'Подписаться' if not current_user.is_following(user) else 'Отписаться' }}
          </button>
        </form>
        {% else %}
        <a href="{{ url_for('edit_profile') }}" class="btn-outline">Редактировать профиль</a>
        {% endif %}
        
        <!-- Кнопка для генерации QR-кода -->
        <button id="generateQrBtn" class="btn-outline">Получить QR-код</button>
      </div>
    </div>
  </div>

  <div class="post-list">
    <h2>Посты</h2>
    {% for post in posts %}
      {% include "_post.html" %}
    {% endfor %}

    <div class="pagination">
      <a href="{{ prev_url or '#' }}" class="{% if not prev_url %}disabled{% endif %}">← Новые посты</a>
      <a href="{{ next_url or '#' }}" class="{% if not next_url %}disabled{% endif %}">Старые посты →</a>
    </div>
  </div>
</div>

<!-- Модальные окна -->
{% include "modals/followers_modal.html" %}
{% include "modals/following_modal.html" %}

<!-- Модальное окно для QR-кода -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">QR-код профиля</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <div id="qrCodeContainer"></div>
        <a id="downloadQrBtn" class="btn btn-primary mt-3" download="profile_qr.png">Скачать QR-код</a>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Подключаем библиотеку QRCode -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<!-- Подключаем наш скрипт -->
<script src="{{ url_for('static', filename='js/profile_qr.js') }}"></script>
{% endblock %}